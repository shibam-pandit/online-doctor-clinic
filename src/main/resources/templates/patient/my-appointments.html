<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Appointments - Patient Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .font-inter {
            font-family: 'Inter', sans-serif;
        }
        
        .appointment-card {
            transition: all 0.3s ease;
        }
        
        .appointment-card:hover {
            transform: translateY(-2px);
        }
        
        .filter-tab.active {
            border-bottom-color: #3b82f6 !important;
            color: #3b82f6 !important;
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6',
                        secondary: '#10b981',
                        accent: '#f59e0b'
                    }
                }
            }
        }
    </script>
</head>

<th:block th:replace="~{fragments/patient-header :: patient-header('My Appointments - Patient Dashboard')}" />

<body class="font-inter antialiased bg-gray-50">
    <!-- Include Patient Sidebar -->
    <div
        th:replace="~{fragments/patient-sidebar :: patient-sidebar('appointments', ${patient != null and patient.getUser() != null ? patient.getUser().getName() : 'Patient'}, ${patient != null ? patient.getId() : 'P001'})}">
    </div>

    <!-- Main Content -->
    <div class="lg:pl-64">
        <!-- Top Header -->
        <header class="bg-white shadow-sm border-b border-gray-200">
            <div class="flex items-center justify-between px-4 py-4 sm:px-6 lg:px-8">
                <div>
                    <h1 class="text-2xl font-bold text-gray-900">My Appointments</h1>
                    <p class="text-sm text-gray-600">View and manage your medical appointments</p>
                </div>

                <div class="flex items-center space-x-4">
                    <!-- Quick Stats -->
                    <div class="hidden sm:flex items-center space-x-6 text-sm">
                        <div class="text-center">
                            <div class="text-lg font-bold text-primary"
                                th:text="${upcomingCount != null ? upcomingCount : 0}">0</div>
                            <div class="text-gray-600">Upcoming</div>
                        </div>
                        <div class="text-center">
                            <div class="text-lg font-bold text-secondary"
                                th:text="${completedCount != null ? completedCount : 0}">0</div>
                            <div class="text-gray-600">Completed</div>
                        </div>
                    </div>

                    <!-- Book New Appointment Button -->
                    <a href="/patient/book-appointment"
                        class="bg-primary text-white px-4 py-2 rounded-lg font-medium hover:bg-blue-700 transition-colors">
                        <i class="fas fa-plus mr-2"></i>Book New
                    </a>
                </div>
            </div>
        </header>

        <!-- Main Content Area -->
        <main class="p-4 sm:p-6 lg:p-8">
            <!-- Alert Messages -->
            <div th:if="${success != null}"
                class="mb-6 bg-green-50 border border-green-200 text-green-800 px-4 py-3 rounded-lg flex items-center success">
                <i class="fas fa-check-circle mr-2"></i>
                <span th:text="${success}">Success message</span>
                <button type="button" class="ml-auto text-green-600 hover:text-green-800"
                    onclick="this.parentElement.style.display='none'">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div th:if="${error != null}"
                class="mb-6 bg-red-50 border border-red-200 text-red-800 px-4 py-3 rounded-lg flex items-center error">
                <i class="fas fa-exclamation-circle mr-2"></i>
                <span th:text="${error}">Error message</span>
                <button type="button" class="ml-auto text-red-600 hover:text-red-800"
                    onclick="this.parentElement.style.display='none'">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <!-- Filter Tabs -->
            <div class="bg-white rounded-xl shadow-lg mb-8">
                <div class="border-b border-gray-200">
                    <nav class="flex space-x-8 px-6" aria-label="Tabs">
                        <button id="allTab"
                            class="filter-tab active border-b-2 border-primary text-primary py-4 px-1 text-sm font-medium"
                            onclick="filterAppointments('all')">
                            All <span class="ml-2 tab-number text-xs px-2 py-1 rounded-full bg-primary text-white"
                                th:text="${totalAppointments != null ? totalAppointments : 0}">0</span>
                        </button>
                        <button id="upcomingTab"
                            class="filter-tab border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 py-4 px-1 text-sm font-medium"
                            onclick="filterAppointments('upcoming')">
                            Upcoming <span class="ml-2 tab-number text-xs px-2 py-1 rounded-full bg-gray-200 text-gray-700"
                                th:text="${upcomingCount != null ? upcomingCount : 0}">0</span>
                        </button>
                        <button id="completedTab"
                            class="filter-tab border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 py-4 px-1 text-sm font-medium"
                            onclick="filterAppointments('completed')">
                            Completed <span class="ml-2 tab-number text-xs px-2 py-1 rounded-full bg-gray-200 text-gray-700"
                                th:text="${completedCount != null ? completedCount : 0}">0</span>
                        </button>
                        <button id="cancelledTab"
                            class="filter-tab border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 py-4 px-1 text-sm font-medium"
                            onclick="filterAppointments('cancelled')">
                            Cancelled <span class="ml-2 tab-number text-xs px-2 py-1 rounded-full bg-gray-200 text-gray-700"
                                th:text="${cancelledCount != null ? cancelledCount : 0}">0</span>
                        </button>
                    </nav>
                </div>
            </div>

            <!-- Appointments Grid -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6" id="appointmentsGrid">

                <!-- Dynamic Upcoming Appointments -->
                <div th:each="appointment : ${upcomingAppointments}"
                    class="appointment-card upcoming bg-white rounded-xl shadow-lg hover:shadow-xl transition-all duration-300">
                    <div class="p-6">
                        <!-- Appointment Header -->
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center space-x-4">
                                <img src="https://images.pexels.com/photos/5407206/pexels-photo-5407206.jpeg?auto=compress&cs=tinysrgb&w=100"
                                    th:alt="'Dr. ' + ${appointment.doctor.user.name}"
                                    class="w-16 h-16 rounded-full object-cover border-2 border-gray-200">
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-900"
                                        th:text="'Dr. ' + ${appointment.doctor.user.name}">Dr. Name</h3>
                                    <p class="text-sm text-primary font-medium"
                                        th:text="${appointment.doctor.specialization}">Specialization</p>
                                    <div class="flex items-center space-x-1 mt-1">
                                        <div class="flex space-x-1">
                                            <i class="fas fa-star text-yellow-400 text-xs"></i>
                                            <i class="fas fa-star text-yellow-400 text-xs"></i>
                                            <i class="fas fa-star text-yellow-400 text-xs"></i>
                                            <i class="fas fa-star text-yellow-400 text-xs"></i>
                                            <i class="fas fa-star text-yellow-400 text-xs"></i>
                                        </div>
                                        <span class="text-xs text-gray-600"
                                            th:text="${appointment.doctor.averageRating != null ? appointment.doctor.averageRating : '5.0'}">5.0</span>
                                    </div>
                                </div>
                            </div>
                            <div class="text-right">
                                <span class="bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm font-medium">
                                    <i class="fas fa-clock mr-1"></i>Upcoming
                                </span>
                            </div>
                        </div>

                        <!-- Appointment Details -->
                        <div class="bg-blue-50 rounded-lg p-4 mb-4">
                            <div class="grid grid-cols-2 gap-4 text-sm">
                                <div>
                                    <span class="text-blue-700 font-medium">Date:</span>
                                    <span class="text-blue-800 ml-2">
                                        <span th:if="${appointment.date.equals(T(java.time.LocalDate).now())}"
                                            th:text="'Today, ' + ${#temporals.format(appointment.date, 'MMM dd')}"></span>
                                        <span th:unless="${appointment.date.equals(T(java.time.LocalDate).now())}"
                                            th:text="${#temporals.format(appointment.date, 'MMM dd, yyyy')}"></span>
                                    </span>
                                </div>
                                <div>
                                    <span class="text-blue-700 font-medium">Time:</span>
                                    <span class="text-blue-800 ml-2"
                                        th:text="${#temporals.format(appointment.slot, 'HH:mm')}">Time</span>
                                </div>
                                <div>
                                    <span class="text-blue-700 font-medium">Duration:</span>
                                    <span class="text-blue-800 ml-2"
                                        th:text="${appointment.durationMinutes} + ' minutes'">Duration</span>
                                </div>
                                <div>
                                    <span class="text-blue-700 font-medium">Fee:</span>
                                    <span class="text-blue-800 ml-2" th:text="'₹' + ${appointment.fee}">Fee</span>
                                </div>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="flex space-x-3">
                            <a th:href="${appointment.meetingLink != null ? appointment.meetingLink : '#'}"
                                th:class="${appointment.meetingLink != null ? 'flex-1 bg-primary text-white px-4 py-3 rounded-lg font-medium hover:bg-blue-700 transition-colors text-center' : 'flex-1 bg-gray-300 text-gray-600 px-4 py-3 rounded-lg font-medium cursor-not-allowed text-center'}"
                                th:target="${appointment.meetingLink != null ? '_blank' : ''}"
                                th:disabled="${appointment.meetingLink == null}">
                                <i class="fas fa-video mr-2"></i>
                                <span
                                    th:text="${appointment.meetingLink != null ? 'Join Call' : 'Link Not Available'}">Join
                                    Call</span>
                            </a>
                            <form th:action="'/patient/cancel-appointment/' + ${appointment.id}" method="post"
                                onsubmit="return confirm('Are you sure you want to cancel this appointment?');">
                                <button type="submit"
                                    class="px-4 py-3 border border-red-300 text-red-600 rounded-lg hover:bg-red-50 transition-colors">
                                    <i class="fas fa-times"></i>
                                </button>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Dynamic Completed Appointments -->
                <div th:each="appointment : ${completedAppointmentsList}"
                    class="appointment-card completed bg-white rounded-xl shadow-lg hover:shadow-xl transition-all duration-300">
                    <div class="p-6">
                        <!-- Appointment Header -->
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center space-x-4">
                                <img src="https://images.pexels.com/photos/5215024/pexels-photo-5215024.jpeg?auto=compress&cs=tinysrgb&w=100"
                                    th:alt="'Dr. ' + ${appointment.doctor.user.name}"
                                    class="w-16 h-16 rounded-full object-cover border-2 border-gray-200">
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-900"
                                        th:text="'Dr. ' + ${appointment.doctor.user.name}">Dr. Name</h3>
                                    <p class="text-sm text-primary font-medium"
                                        th:text="${appointment.doctor.specialization}">Specialization</p>
                                    <div class="flex items-center space-x-1 mt-1">
                                        <div class="flex space-x-1">
                                            <i class="fas fa-star text-yellow-400 text-xs"></i>
                                            <i class="fas fa-star text-yellow-400 text-xs"></i>
                                            <i class="fas fa-star text-yellow-400 text-xs"></i>
                                            <i class="fas fa-star text-yellow-400 text-xs"></i>
                                            <i class="fas fa-star text-yellow-400 text-xs"></i>
                                        </div>
                                        <span class="text-xs text-gray-600"
                                            th:text="${appointment.doctor.averageRating != null ? appointment.doctor.averageRating : '5.0'}">5.0</span>
                                    </div>
                                </div>
                            </div>
                            <div class="text-right">
                                <span class="bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm font-medium">
                                    <i class="fas fa-check mr-1"></i>Completed
                                </span>
                            </div>
                        </div>

                        <!-- Appointment Details -->
                        <div class="bg-gray-50 rounded-lg p-4 mb-4">
                            <div class="grid grid-cols-2 gap-4 text-sm">
                                <div>
                                    <span class="text-gray-700 font-medium">Date:</span>
                                    <span class="text-gray-800 ml-2"
                                        th:text="${#temporals.format(appointment.date, 'MMM dd, yyyy')}">Date</span>
                                </div>
                                <div>
                                    <span class="text-gray-700 font-medium">Time:</span>
                                    <span class="text-gray-800 ml-2"
                                        th:text="${#temporals.format(appointment.slot, 'HH:mm')}">Time</span>
                                </div>
                                <div>
                                    <span class="text-gray-700 font-medium">Duration:</span>
                                    <span class="text-gray-800 ml-2"
                                        th:text="${appointment.durationMinutes} + ' minutes'">Duration</span>
                                </div>
                                <div>
                                    <span class="text-gray-700 font-medium">Fee:</span>
                                    <span class="text-gray-800 ml-2" th:text="'₹' + ${appointment.fee}">Fee</span>
                                </div>
                            </div>
                        </div>

                        <!-- Status Information -->
                        <div class="bg-green-50 rounded-lg p-4 mb-4">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <i class="fas fa-check-circle text-green-600 mr-2"></i>
                                    <span class="text-sm font-medium text-green-800">Consultation Completed</span>
                                </div>
                                <span class="text-xs text-green-600 bg-green-200 px-2 py-1 rounded-full">
                                    <span th:text="${#temporals.format(appointment.date, 'MMM dd')}">Date</span>
                                </span>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="flex space-x-3">
                            <a th:href="'/patient/book-slot/' + ${appointment.doctor.id}"
                                class="flex-1 bg-secondary text-white px-4 py-3 rounded-lg font-medium hover:bg-green-700 transition-colors text-center">
                                <i class="fas fa-redo mr-2"></i>Book Again
                            </a>
                            <button
                                class="px-4 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors"
                                onclick="alert('Receipt download feature coming soon!')">
                                <i class="fas fa-download"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Dynamic Cancelled Appointments -->
                <div th:each="appointment : ${cancelledAppointmentsList}"
                    class="appointment-card cancelled bg-white rounded-xl shadow-lg hover:shadow-xl transition-all duration-300">
                    <div class="p-6">
                        <!-- Appointment Header -->
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center space-x-4">
                                <img src="https://images.pexels.com/photos/5452201/pexels-photo-5452201.jpeg?auto=compress&cs=tinysrgb&w=100"
                                    th:alt="'Dr. ' + ${appointment.doctor.user.name}"
                                    class="w-16 h-16 rounded-full object-cover border-2 border-gray-200 grayscale">
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-600"
                                        th:text="'Dr. ' + ${appointment.doctor.user.name}">Dr. Name</h3>
                                    <p class="text-sm text-gray-500 font-medium"
                                        th:text="${appointment.doctor.specialization}">Specialization</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <span class="bg-red-100 text-red-800 px-3 py-1 rounded-full text-sm font-medium">
                                    <i class="fas fa-times mr-1"></i>Cancelled
                                </span>
                            </div>
                        </div>

                        <!-- Appointment Details -->
                        <div class="bg-red-50 rounded-lg p-4 mb-4">
                            <div class="grid grid-cols-2 gap-4 text-sm">
                                <div>
                                    <span class="text-red-700 font-medium">Date:</span>
                                    <span class="text-red-800 ml-2"
                                        th:text="${#temporals.format(appointment.date, 'MMM dd, yyyy')}">Date</span>
                                </div>
                                <div>
                                    <span class="text-red-700 font-medium">Time:</span>
                                    <span class="text-red-800 ml-2"
                                        th:text="${#temporals.format(appointment.slot, 'HH:mm')}">Time</span>
                                </div>
                                <div>
                                    <span class="text-red-700 font-medium">Status:</span>
                                    <span class="text-red-800 ml-2"
                                        th:text="${appointment.status == T(com.shibam.clinic.online_doctor_clinic.Models.Appointment.AppointmentStatus).CANCELLED_BY_PATIENT ? 'Cancelled by You' : 'Cancelled by Doctor'}">Cancelled</span>
                                </div>
                                <div>
                                    <span class="text-red-700 font-medium">Fee:</span>
                                    <span class="text-red-800 ml-2"
                                        th:text="'₹' + ${appointment.fee} + ' (Refunded)'">Fee</span>
                                </div>
                            </div>
                        </div>

                        <!-- Action Button -->
                        <div class="flex space-x-3">
                            <a th:href="'/patient/book-slot/' + ${appointment.doctor.id}"
                                class="flex-1 bg-primary text-white px-4 py-3 rounded-lg font-medium hover:bg-blue-700 transition-colors text-center">
                                <i class="fas fa-redo mr-2"></i>Book Again
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Empty State -->
            <div id="emptyState" th:style="${totalAppointments == 0 ? '' : 'display: none;'}" class="text-center py-16">
                <i class="fas fa-calendar-times text-gray-300 text-6xl mb-4"></i>
                <h3 class="text-xl font-medium text-gray-900 mb-2">No Appointments Found</h3>
                <p class="text-gray-600 mb-6">You don't have any appointments yet.</p>
                <a href="/patient/book-appointment"
                    class="bg-primary text-white px-6 py-3 rounded-lg font-medium hover:bg-blue-700 transition-colors">
                    <i class="fas fa-plus mr-2"></i>Book Your First Appointment
                </a>
            </div>

            <!-- Load More Button -->
            <div th:if="${totalAppointments > 0}" class="text-center mt-8">
                <button
                    class="bg-gray-100 text-gray-700 px-8 py-3 rounded-lg font-medium hover:bg-gray-200 transition-colors">
                    <i class="fas fa-plus mr-2"></i>Load More Appointments
                </button>
            </div>
        </main>
    </div>

    <script>
        // Filter functionality
        function filterAppointments(status) {
            const cards = document.querySelectorAll('.appointment-card');
            const tabs = document.querySelectorAll('.filter-tab');
            const emptyState = document.getElementById('emptyState');

            // Update tab styles
            tabs.forEach(tab => {
                tab.classList.remove('active', 'border-primary', 'text-primary');
                tab.classList.add('border-transparent', 'text-gray-500');
                const tabNumber = tab.querySelector('.tab-number');
                if (tabNumber) {
                    tabNumber.classList.remove('bg-primary', 'text-white');
                    tabNumber.classList.add('bg-gray-200', 'text-gray-700');
                }
            });

            const activeTab = document.getElementById(status + 'Tab');
            if (activeTab) {
                activeTab.classList.add('active', 'border-primary', 'text-primary');
                activeTab.classList.remove('border-transparent', 'text-gray-500');
                const activeTabNumber = activeTab.querySelector('.tab-number');
                if (activeTabNumber) {
                    activeTabNumber.classList.add('bg-primary', 'text-white');
                    activeTabNumber.classList.remove('bg-gray-200', 'text-gray-700');
                }
            }

            // Filter cards
            let visibleCount = 0;
            cards.forEach(card => {
                if (status === 'all' || card.classList.contains(status)) {
                    card.style.display = 'block';
                    visibleCount++;
                } else {
                    card.style.display = 'none';
                }
            });

            // Show/hide empty state
            if (visibleCount === 0) {
                emptyState.style.display = 'block';
                emptyState.classList.remove('hidden');
            } else {
                emptyState.style.display = 'none';
                emptyState.classList.add('hidden');
            }
        }

        // Auto-dismiss alerts after 5 seconds
        setTimeout(() => {
            const alerts = document.querySelectorAll('.success, .error');
            alerts.forEach(alert => {
                if (alert.style.display !== 'none') {
                    alert.style.opacity = '0';
                    setTimeout(() => alert.style.display = 'none', 300);
                }
            });
        }, 5000);

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            // Set default active tab
            filterAppointments('all');
        });
    </script>
</body>

</html>